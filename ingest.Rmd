---
title: "ingest"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE}
library(data.table)

options(scipen = 999)  # disable scientific notation

# Function to load CSVs and normalize column names
load_csv <- function(path) {
  dt <- fread(path)
  setnames(dt, toupper(names(dt)))
  return(dt)
}

drg_info <- load_csv("data/DRG_INFODETAILS.csv")        
drg_procedure <- load_csv("data/DRG_PROCEDURE.csv")     
drg_diagnosis <- load_csv("data/DRG_DIAGNOSIS.csv")     
drg_warning_error <- load_csv("data/DRG_WARNING_ERROR.csv") 
drg_audittrail <- load_csv("data/DRG_AUDITRAIL.csv")    
```

# ---------------- Join all tables using SERIES / LHIO / CLAIMNUMBER ----------------

```{r}
# Join step by step
master <- merge(
  drg_info, drg_procedure,
  by.x = c("SERIES","LHIO","CLAIMNUMBER"), 
  by.y = c("SERIES","LHIO","CLAIM_ID"),
  all.x = TRUE, suffixes = c("", "_PROC")
)

master <- merge(
  master, drg_diagnosis,
  by.x = c("SERIES","LHIO","CLAIMNUMBER"), 
  by.y = c("SERIES","LHIO","CLAIM_ID"),
  all.x = TRUE, suffixes = c("", "_DIAG")
)

master <- merge(
  master, drg_warning_error,
  by.x = c("SERIES","LHIO","CLAIMNUMBER"), 
  by.y = c("SERIES","LHIO","CLAIM_ID"),
  all.x = TRUE, suffixes = c("", "_WARN")
)

# DRG_AUDITTRAIL has no LHIO
master <- merge(
  master, drg_audittrail,
  by = c("SERIES","CLAIMNUMBER"),
  all.x = TRUE, suffixes = c("", "_AUDIT")
)

# Convert ID-like columns to character
id_cols <- grep("ID$|CLAIMNUMBER$|SERIES|LHIO", names(master), value = TRUE)
master[, (id_cols) := lapply(.SD, as.character), .SDcols = id_cols]

# Create human-readable composite key
master[, COMPOSITE_KEY := paste(ID, SERIES, LHIO, CLAIMNUMBER, sep = "_")]

cat("Initial long table → Rows:", nrow(master), " Cols:", ncol(master), "\n")
```

# ---------------- Collapse duplicates into one row per composite key ----------------

```{r}
# Collapse duplicates per composite key
collapse_fun <- function(x) {
  vals <- unique(na.omit(x))
  paste(vals, collapse = "||")
}

master_flat <- master[, lapply(.SD, collapse_fun), by = COMPOSITE_KEY]

cat("Collapsed final table → Rows:", nrow(master_flat), " Cols:", ncol(master_flat), "\n")
head(master_flat)
```

# ---------------- Export Master Table ----------------

```{r}
fwrite(master_flat, "data/master_table_flat.csv")
cat("Master table saved to: data/master_table_flat.csv\n")
fwrite(master, "data/master_table.csv")
cat("Master table saved to: data/master_table.csv\n")
```

```{r}
library(data.table)

detect_type <- function(value) {
  # Patterns
  is_numeric <- grepl("^[0-9.]+$", value)
  is_alpha <- grepl("^[A-Za-z]+$", value)
  is_alnum <- grepl("^[A-Za-z0-9.]+$", value)
  is_date <- grepl("^\\d{2}/\\d{2}/\\d{4}(\\s+\\d{2}\\.\\d{2}\\.\\d{2}\\.\\d+\\s*(AM|PM)?)?$", value, ignore.case = TRUE)
  
  if (is_date) {
    return("DATE (any format)")
  } else if (is_numeric) {
    return("NUMERICAL (0-9. only)")
  } else if (is_alpha) {
    return("ALPHABETICAL (a-zA-Z only)")
  } else if (is_alnum) {
    return("ALPHANUMERICAL (a-zA-Z0-9.)")
  } else {
    return("STRING (also has char other than a-zA-Z0-9.)")
  }
}

for (i in seq_along(master)) {
  colname <- names(master)[i]
  values <- unique(master[[i]])
  values <- as.character(values)
  values <- values[!is.na(values)]  # keep empty string if exists
  
  cat("COL", i, ": ", colname, "\n", sep = "")
  
  if (length(unique(values)) < 10) {
    # Print all unique values if less than 10
    cat(values, sep = "\n")
  } else {
    # Otherwise, one representative per type
    types <- sapply(values[values != ""], detect_type)
    reps <- tapply(values[values != ""], types, `[`, 1)
    cat(reps, sep = "\n")
  }
  
  # Determine all types present
  types_all <- sapply(values[values != ""], detect_type)
  types_unique <- unique(types_all)
  
  # Include EMPTY type if there are blank values
  if (any(values == "")) {
    types_unique <- c(types_unique, "EMPTY")
  }
  
  cat("\nFORMAT:\n")
  cat(types_unique, sep = "\n")
  cat("\n\n")
}

```
